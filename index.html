<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Redirecting to Perplexity...</title>
</head>
<body>
    <p>Redirecting to Perplexity（転送中）</p>
    <script>
        /**
         * URLパラメータを解析し、Perplexityへリダイレクトを行う関数
         * @return {void}
         */
        const redirectToPerplexity = () => {
            try {
                console.log('Redirect process started.');

                // アクセス制御: ローカル環境は許可し、本番環境ではREADME（GitHub）からの遷移のみ許可
                const referrer = document.referrer;
                const hostname = window.location.hostname;
                const allowedPath = "hiroshikuze/escape_from_tsunami_for_bing_chat";
                const isLocal = hostname === "127.0.0.1" || hostname === "localhost";

                if (!isLocal && (!referrer || !referrer.includes(allowedPath))) {
                    console.warn(`Access denied. Referrer: ${referrer}`);
                    document.body.innerHTML = "Access denied. Please access from the official README.<br>（公式READMEからアクセスしてください）";
                    return;
                }

                // URLパラメータから "q" の値を取得
                const urlParams = new URLSearchParams(window.location.search);
                const prompt = urlParams.get('q');

                if (prompt) {
                    console.log(`Prompt found (raw): ${prompt}`);
                    // アンダースコアを半角スペースに置換
                    const decodedPrompt = prompt.replaceAll('_', ' ');
                    console.log(`Prompt decoded: ${decodedPrompt}`);

                    // Perplexityの検索URLを構築
                    const perplexityUrl = `https://www.perplexity.ai/search?q=${encodeURIComponent(decodedPrompt)}`;
                    console.log(`Redirecting to: ${perplexityUrl}`);
                    // 自動リダイレクト
                    window.location.href = perplexityUrl;
                } else {
                    console.warn('Prompt not found in URL parameters.');
                    document.body.innerHTML = "Cant find prompt（プロンプトが見つかりませんでした）";
                }
            } catch (error) {
                console.error('An error occurred during redirection:', error);
                document.body.innerHTML = "Error occurred（エラーが発生しました）";
            }
        };

        // 実行
        redirectToPerplexity();
    </script>
</body>
</html>
